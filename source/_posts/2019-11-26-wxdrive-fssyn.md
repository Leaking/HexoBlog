---
title: 微盘文件系统的同步
date: 2019-11-26 23:12:06
tags: [FileSystem]
---

微盘作为企业微信的办公协作套件之一，2019年年底已上线。微盘除了在客户端内支持常见的文件操作，在本地文件浏览器的文件操作也可以实时同步。这篇文章主要围绕微盘的文件同步系统展开。

### 微盘文件同步系统的组成

微盘文件同步系统主要由四部分组成

+ 

先提一个技术背景，微盘的桌面客户端，是基于Electron开发的跨平台应用，所以我们主要基于nodejs开发。

微盘的同步可以分为以下四个模块

![](/images/wedrive_sync_4_part.png)

+ 客户端: 来自客户端的文件操作，支持上传、下载、重命名、移动、删除等
+ 监听：微盘运行过程中，实时监听本地盘符内的操作并同步给服务器，包括修改内容、上传、下载、重命名、移动、删除、新建文件夹（微盘下载的文件会存在本地某个目录内，我们这篇文章将这个目录成为盘符）
+ 离线同步：微盘在不运行期间，盘符目录内的修改，也需要在应用启动后同步给服务器
+ 服务器同步：微盘客户端实时从服务器同步其他同事的文件修改

微盘的桌面客户端其实可以理解为有两个客户端存在，一个是我们传统意义上理解的GUI界面，一个是本地盘符。二者基本具备一样的文件相关的功能，

我们接下来将围绕监听、离线同步、服务器同步三个点介绍。


# 微盘文件的索引

为了


# 微盘的监听

nodejs支持的文件监听能力比较有限，经过简单的筛选，我们可以获得文件的新增、删除、修改这种三种事件，但是不支持文件的重命名和移动事件。而nodejs平台文件监听相关的开源组件，应该就属choakir最出名了，毕竟vsocde等知名应用了使用了这个组件，但是，这个组件一直依赖也没支持重命名和移动事件。所以我们为了解决这个问题，需要自己开发，支持监听文件的重命名和移动事件的监听。

我们来看看nodejs提供的监听接口


我们可以发现，每一次文件的重命名和移动，都会触发一个新增事件和删除事件，这两个事件几乎会在同一时间出现（先出现删除后出现新增），我们只需要将这种成对的事件串起来，就可以识别重命名和移动事件，我们知道，在现代的文件系统中对一个文件重命名或者移动，文件的Inode number是不变的，Inode number可以理解为文件在当前分区的唯一ID（虽然Inode是类UNIX的系统的概念，但是Windows也有类似实现）。所以我们只需要将盘符里的所有文件的Inode number记录到数据库，则可以把新增事件和删除事件串起来，推断出重命名或者移动事件。如下图

![](/images/wedrive_01.png)


而从nodejs提供的监听接口，其实我们接收到的事件，需要进一步筛选过滤（结束本地文件和数据库），才能得到准确的事件，比如，

+ 有些文件并没发生修改，只是被其他应用程序Access一下而已
+ 有些编辑软件，每次保存文件，都是把原文件删除，然后再新建一份，就算内容没有修改
+ 我们客户端主动触发的操作，比如重命名，我们除了把同步操作同步给服务器，还要把本地文件重命名，这事也会触发事件，也是需要过滤掉的


目前监听模块对事件的整体流转与过滤如下图

![](/images/wedrive_02.png)

初次之外，我们应用还需要过滤一些主流软件生成的临时文件，以及软/硬链接文件等特殊文件类型，而这里提到的主流软件临时文件，我们可以通过简单的正则过滤

```
const EXCLUDED_FILENAME_FORMAT_REG = [
  // finder/explore临时文件
  /^.DS_Store$/,
  /^thumbs.db$/,
  /^desktop.ini$/,
  // office临时文件
  /^~\$/,
  /^.~/,
  /^~.+\.tmp$/,
  // vim临时文件
  /.swp$/,
  /.swo$/,
  /.swn$/,
  // windows下，.字符结尾文件是特殊文件，空格结尾也是
  /\.$/,
  / $/,
  // .WeDrive是项目私有隐藏文件
  /^.WeDrive$/
]
```


## 离线同步

前面介绍的文件监听，是微盘运行期间，我们才能监听到盘符内的变化，如果应用退出期间，用户对本地文件做了修改，我们要怎么处理呢？




## 服务器同步






