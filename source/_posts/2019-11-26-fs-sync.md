---
title: 微盘文件系统的同步
date: 2019-11-26 23:12:06
tags: [FileSystem]
---

我们平时在互联网上使用的文件存储服务常见的有两种，第一种是百度网盘，第二种是Dropbox，Google Drive这一流派。他们最大的区别在于是不是被墙了，不过，我们今天不是讨论GFW，也不是讲科学上网。而是探讨如何实现类似Dropbox的文件系统同步方案。程序员群体，大部分人应该都使用或了解过Dropbox，如果没有也无妨，我们会先简单介绍一下Dropbox的基本功能，以及一些充钱让人变强之后才具备的功能。   




## Dropbox 产品介绍

Dropbox这一类的网盘，除了具备百度网盘的上传下载功能，具备文件版本，团队协作


## 文件监听

说到文件监听，可能大家最开始想到的linux中的select/poll/epoll这一套东西，不过epoll这一套是用于IO多路复用，比如监听一个socket文件是否已经有内容可以读了。而我们这里要监听的，是文件内容更新，重命名，新增文件，删除文件等等。而现代的文件系统都从底层支持了文件变化的监听，如下图

|       System     | File Monitor     |
| ---------- | :-----------: |
| Windows     |  ReadDirectoryChangesW     |
| Darwin     | FSEvents or kqueue     |
| BSDs     |  kqueue     |
| Linux     |  inotify     |
| Solaris     |  event ports     |

nodejs底层的libuv就对上面这些接口进行了封装，这里也是libuv中碎片化最严重的一个模块。我们的应用运行于Mac OS X和Windows系统上，所以我们着重来讲讲它们使用的FSEvents，kqueue，ReadDirectoryChangesW

# Mac OS X - kqueue
kqueue是BSD上开发的对应Linux上epoll的一套接口，不过它涵盖的功能比epoll更宽广。还另外还支持文件内容监听，跨进程通信等等，如下图。

![](/images/wedrive_kqueue.png)

但是拿kqueue来做一整个文件树的监听的话，每个文件夹都需要打开一个文件句柄(file descriptor)，而每个进程能打开的文件句柄数量是有限的，所以kqueue作为任意大小的文件树的监听，并不合适。

# Mac OS X - FSEvents
Mac OS X后来推出了新的文件监听方案：FSEvents，这套东西比较有趣，我们稍微花点篇幅介绍一下它的原理。你是否偶然注意到，Mac上有这么一个fseventsd的系统进程。

![](/images/wedrive_fsevent01.png)

用户空间发生对文件的修改时，该修改记录到文件系统后，文件系统将文件的修改事件记录到/dev/fsevent文件，这是一个符号设备文件，然后系统进程fsevent读取/dev/fsevent文件中的事件，系统进程fsevent再和其他通过FSEvent API注册了文件监听的应用程序通信，将它们感兴趣的事件传递过去。

![](/images/wedrive_fsevents.png)

Mac上文件系统中的每个分卷的根目录都有这样一个隐藏目录: .fseventsd
![](/images/wedrive_fsevent02.png)

这个文件夹里的文件是记录当前分区所有文件事件的日志，这些日志类似于NTFS 的USD日志，.fseventsd里的日志大有用途，比如Mac的Time Machine在做备份时，就可以从.fseventsd日志中读取上次备份事件点之后发生变化的文件，针对这些文件做备份，而如果由于其他原因，.fseventsd日志丢失了，Time Machine则需要做一次全盘扫描，依靠每个文件的modification time来找出上次备份之后发生变化的所有文件。.fseventsd日志格式不难理解，在看雪论坛挖到一篇关于
.fseventsd日志解析的文章，挺有意思的，其中引申到.fseventsd日志的取证用途和带来的安全问题。

[苹果FSEvent深层文件系统调用记录方法论](https://bbs.pediy.com/thread-221578.htm)

<!-- inotify on Linux, FSEvents on Darwin, kqueue on BSDs, ReadDirectoryChangesW on Windows, event ports on Solaris, unsupported on Cygwin -->

从Mac OS X 10.7开始，libuv使用fsevent处理文件监听



## 写作笔记、素材
不能一味按照dropbox功能实现来写
如果介绍处微盘和dropbox的不同

usn是NTFS用于记录文件变更的日志，everything就是基于它做搜索的
https://docs.microsoft.com/en-us/windows/win32/fileio/change-journals

kqueue会占用大量fd,(待验证)
https://news.ycombinator.com/item?id=9063477


fsevent !!
OS X 10.5和10.6仅能捕获与文件夹相关的事件， 从OS X 10.7开始引入文件事件。 类似于Windows系统的NTFS日志（该日志记录一直文件系统活动，并将数据存储在UsnJrnl:$J中），FSEvents也一直记录文件系统变化，并将数据存储在FSEvent日志文件中。
这篇很赞
https://bbs.pediy.com/thread-221578.htm
https://eclecticlight.co/2017/09/12/watching-macos-file-systems-fsevents-and-volume-journals/