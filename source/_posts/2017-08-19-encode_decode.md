---
title: 关于字符编码的一切
date: 2017-08-19 19:16:06
toc: true
tags: Android
---

字符编码应用广泛，除了用于处理字符和二进制数据的对应关系，也应用于譬如Baes64编码和URL编码这种网络中的编码。这里对相关知识做一次全面的总结，写下我的理解。

本文将讲解以下几个点：

+ ASCII的缺陷
+ Unicode的历史
+ UTF和UCS的关系
+ UTF-8的设计和原理
+ UTF-16的设计和原理
+ 字节序BOM
+ Base64编码
+ URL编码


# ASCII码

ASCII，全称American Standard Code for Information Interchange。规定了拉丁字符和二进制位之间的对应关系，这个标准描述了拉丁字符中128个字符，其中包含33个控制字符
（比如换行符，换页符），95个可显示字符（其中包括大小写字母各26个，10个阿拉伯数字，以及其他标点符号）。2^7=128，所以使用一个字节就可以描述ASCII码标准中的128个字符，并且只需要使用前7位，最高位恒为0。ASCII码的对应关系见以下表格

![HASCII码](/images/ascii.png)

ASCII码存在一个致命的缺陷，就是涵盖的字符只有英语字符，所以无法适用于其他语言的字符，比如中文，日语等等，于是急需一套具备普适性的编码标准，于是出现了Unicode。


# Unicode

## Unicode的历史

关于Unicode的介绍，要先从字符集的发展历史讲起，让我们来一次性理清平时能见到的种种字符集的来龙去脉。

最开始，计算机在美国发明，于是美国人发明了只支持英文的ASCII码字符集，但随着计算机在全世界普及，需要面对其他语言的字符，于是其他语言的地区陆续推出自己的字符集，并且基本都向下兼容ASCII。

+ ISO/IEC 8859 字符集

这是拉丁语系国家推出了字符集，和ASCII码一样，也是单字节字符集，其特点是扩充了ASCII空置的128-255的范围，加入了其他字符。ISO/IEC 8859有很多系列，从ISO/IEC 8859-1到ISO/IEC 8859-15（中间废弃了一个IEC 8859-12）。

+ GB2312、GBK、GB18030字符集

这是针对简体中文推出的三个字符集(有一个繁体中文字符集叫big5)，它们都是双字节的字符集，而且都向下兼容ASCII。依次按照GB2312、GBK、GB18030的顺序发展，排前面的是排后面的子集，而我们最常使用的是GBK，它包含的中文字符已经足够我们日常使用，所以平时见到GBK比见到GB18030多。

+ 其他语言地区推出其他的字符集...


按照这个“百花齐放”的形式发展下去，势必严重影响计算机科学的长远发展，每推出一个字符集都会增加一个包袱。为了解决这个问题，人们尝试寻找一套统一的字符集标准，统一这个混乱的局面。

于是同时有两个组织开始研究这件事情，

+ 鼎鼎大名的国际标准化组织ISO推出了ISO/IEC 10646标准，该标准定义了一个统一的字符集："Universal Multiple-Octet Coded Character Set"，简称UCS。它涵盖两种编码方式：UCS-2和UCS-4，它们分别使用16bit和32bit存储一个字符，可以大致等同于后续介绍的UTF-16和UTF-32，但是UCS-2和UTF-16还是存在一定差别，后续会介绍。

+ 美国一个软件制造商协会推出一套统一字符集：Unicode，最开始它是设计为一个字符存储于2个字节的编码方式，也就是UTF-16，而如今支持的编码方式有三种：UTF-8，UTF-16，UTF-32.

这两个协会后来发现了对方都在做同样的事，而人类无需两套字符集，于是这两家机构合并了彼此的研究成果，诞生了现在的Unicode！！Unicode有一句口号：enabling people around the world to use computers in any language。

Unicode的编码空间从U+0000到U+10FFFF，共有1,112,064个码位（code point）可用来映射字符. 每个字符用十六进制表示，并带上“U+”前缀，比如U+0041表示大写拉丁字母A。截止目前为止，Unicode在2017六月发布最新版本10.0.0，Unicode只使用了U+0000到U+10FFFF这个编码控件12%左右的为止，每年Unicode都在扩展新的字符，比如每年都有复杂的汉字在申请加入Unicode规范，而笔画多得丧心病狂的biangbiang面的biang字，Unicode 10.0.0都仍未收录它，所以，目前我们在电脑上还是无法打出这个字。

接下来我们介绍一下编码空间划分平面的概念，从U+000000到U+10FFFF，Unicode的编码空间可以划分为17个平面（plane），每个平面包含2^16（65,536）个码位。17个平面的码位可表示为从U+xx0000到U+xxFFFF，其中xx表示十六进制值从0016到1016，共计17个平面。第一个平面称为基本多语言平面（Basic Multilingual Plane, BMP），或称第零平面（Plane 0）。其他平面称为辅助平面（Supplementary Planes）。基本多语言平面内，从U+D800到U+DFFF之间的码位区块是永久保留不映射到Unicode字符。UTF-16就利用保留下来的0xD800-0xDFFF区段的码位来对辅助平面的字符的码位进行编码。

我们通过可视化的形式看一下Unicode编码空间目前的大致情况，其中每个小方格表示16 * 16 = 256个字符，每个大方格表示一个平面（plane），大小等于65535，整副图表示了17个平面。

![Unicode码元占用情况](/images/unicode-codespace.png)

我们可以发现，目前大部分Unicode处于前三个平面内，空白方格表示未使用的码位，蓝色代表已经使用的码位，绿色表示私有区域（用于干嘛呢？再研究），而红色区域是surrogate区域（维基百科上翻译为代理区域），这个区域主要用于扩展UTF-16，用于UTF-16显示在16bit编码空间之外的字符，后面介绍UTF-16会详细介绍surrogate区域。

第0平面包含了绝大部分我们日常能见到的字符，包括各种常见语言，英文、希腊语、中文、日文、韩文、希伯来语等等。而第1平面包含很多历史字符，以及emoji字符，而第2平面包含了很多汉字。其他平面，第14平面使用了很少一部分，第15、16平面用于私有空间，

我们再来看看Unicode编码空间前三个平面中语言的分布

![Unicode语种分布情况](/images/unicode-scipt-type.png)

其中占据最多的蓝色代表汉字，而棕色代表韩文，这两种语言占据了前三个平面大部分的空间。

我们再来看一个更有意思的，下图显示前三个平面内，各个Unicode字符的使用频率，黑色代表频率最低，依次按红色，黄色再到白色递增。


![Unicode使用频率](/images/unicode-frequency.png)

我们可以发现，第0平面（BMP）包含的字符使用最多，只有少部分处在第1和第2平面，而第1平面最后一行的之所以显示使用频率那么高，是因为那个区域对应着emoji字符。


## UTF、UCS的关系

上面我们介绍了Unicode的字符集，以及起大概的分布情况，而关于Unicode还有一个重要的点，就是怎么使用二进制的形式来存储和传输Unicode，这就是Unicode编码的问题，也称为Unicode Transformation Format，简称UTF。目前Unicode官方支持的编码方式有三种：UTF-8，UTF-16，UTF-32。而我们常见的`Unicode编码`，这种说法其实不大准确，但是可以注意一点，很多地方默认`Unicode编码`对应的就是UTF-16编码。

在介绍三种UTF编码方式之前，我们先讲讲另一个相关的概念，同时也是一个历史问题，就是UCS，我们前面讲到Unicode最开始是合并了ISO创建的UCS字符集，而这个UCS字符集存在两种编码方式，分别是UCS-2和UCS-4，它们分别占用2个字节，和4个字节。从Unicode 1.1开始，已经废弃了UCS-2编码方式，而被UTF-16代替，UCS-2只能描述2个字节内的字节，超过两个字节则不能描述，而作为UCS-2超集的UTF-16则可以。

UTF-8，UTF-16，UTF-32这三种编码方式，其中UTF-32是定长（4个字节）的编码方式，而`UTF-8`和`UTF-16`是变长的编码方式，UTF-8最开始的定义是可以使用1至6个字节代表一个字符的，后来改为1至4个字节，而UTF-16则可以使用2个或者4个字节。

接下来介绍两种变长的的编码UTF-8和UTF-16的实现原理。


## UTF-8的实现原理

UTF-8的编码规则可以概括为二条：
+ 单字节的字符，字节的第一位设为0，后面7位为这个符号的Unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。
+ 对于n字节(n = 2,3,4)的字符，第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的unicode码。

所以，UTF-8的字符编码区间如下，表格中，x位是有效的二进制位，它们拼接起来就是对应的Unicode，表中的1和0，只是用于描述当前字符占用几个字节。而其中的最小值和最大值，只考虑x位的值。

字节数 | 最小值 | 最大值 | Byte 1 | Byte 2 | Byte 3 | Byte 4
--- | --- | --- | --- | --- | --- | --- 
1|U+0000|U+007F|0xxxxxxx|||
2|U+0080|U+07FF|110xxxxx|10xxxxxx||
3|U+0800|U+FFFF|1110xxxx|10xxxxxx|10xxxxxx|
4|U+10000|U+1FFFFF|11110xxx|10xxxxxx|10xxxxxx|10xxxxxx

接下来举两个例子：

比如，希伯来语字母aleph（א）的Unicode代码是U+05D0，我们按照上面的表格将其转化成UTF-8，`U+05D0`属于U+0080到U+07FF区域，根据以上表格，说明它使用双字节的格式：110xxxxx 10xxxxxx.
十六进制的0x05D0换算成二进制就是101-1101-0000.这11位数按顺序放入x部分：11010111 10010000.
最后结果用十六进制写起来就是0xD7 0x90，这就是这个字符aleph（א）的UTF-8编码。

再举个例子，汉字“啊"的unicode是U+554A（0101 0101 0100 1010），根据上表，可以发现U+554A处在第三行的范围内（0000 0800-0000 FFFF），因此“啊"的UTF-8编码需要三个字节，即格式是`1110xxxx 10xxxxxx 10xxxxxx`。然后，从“啊"的最后一个二进制位开始，依次从后向前填入格式中的x，多出的位在高位补0。这样就得到了，“啊"的UTF-8编码是"11100101 10010101 10001010"，转换成十六进制就是0xE5958A。
 
## UTF-16的实现原理

Unicode的编码空间从U+0000到U+10FFFF，其中跨越了第0平面（BMP平面）和第1平面，我们可以将其分为U+0000到U+FFFF和U+10000到U+10FFFF两个区间，而U+0000到U+FFFF区间内有一个部分U+D800到U+DFFF是用于代理区域的（surrogate area）,从U+D800到U+DFFF之间的码位区块是永久保留不映射到Unicode字符。UTF-16就利用保留下来的0xD800-0xDFFF区段的码位来对第1平面的字符（U+10000到U+10FFFF）的码位进行编码。

**从U+0000至U+D7FF以及从U+E000至U+FFFF的码位**

这个是BMP平面去掉代理区域U+D800到U+DFFF剩下的区域，UTF-16使用两个字节编码这个范围内的码位，而UCS-2也可以编码这个区域的Unicode字符，这个区域是UTF-16和UCS-2唯一的交集。

**从U+10000到U+10FFFF的码位**

辅助平面中的码位，在UTF-16中被编码为32bit=4字节。







## BOM


Unicode中，单字节留给了ASCII码，而重音文字、希腊字母等使用2字节来存储，而常用的汉字、韩文等亚洲方块字则使用3字节。其他复杂字符则使用4字节。

与其他Unicode编码相比，特别是UTF-16，在UTF-8中ASCII字符占用的空间只有一半，可是在一些字符的UTF-8编码占用的空间就要多出1/3，特别是中文、日文和韩文（CJK）这样的方块文字，UTF-16只需两个字节，而UTF-8需要三个字节。



1、big endian little endian
2、文件头
3、EF、BB、BF  乱码问题

big endian little endian

Unicode、Unicode big endian和UTF-8编码的txt文件的开头会多出几个字节，分别是FF、FE（Unicode）,FE、FF（Unicode big endian）,EF、BB、BF（UTF-8）





http://pcedu.pconline.com.cn/empolder/gj/other/0505/616631_all.html#content_page_2


## Base64编码



## URL编码



## 参考

ISO 8859字符集的介绍
https://zh.wikipedia.org/wiki/ISO/IEC_8859#.E7.B1.BB.E4.BC.BCISO_8859.E7.9A.84.E7.BC.96.E7.A0.81 

emoji表情
http://www.unicode.org/emoji/charts/emoji-versions.html#2017


