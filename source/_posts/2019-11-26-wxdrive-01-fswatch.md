---
title: 微盘文件同步系统------文件监听
date: 2019-11-26 23:12:06
tags: [FileSystem]
---

微盘支持从客户端上传文件，也支持往微盘在本地的存储位置里放入文件，就能触发自动上传，后续对文件内容的修改，以及文件重命名，文件移动位置等，都能被自动识别并同步，这篇文章我们就来介绍一下我们如何实现微盘的文件监听功能。

微盘的桌面客户端是基于Electron开发的应用程序，自然我们需要先到NodeJs中寻找如何实现文件监听，我们先来看一下

```javascript
const fs = require('fs')
const path = require('path')
const wedrive = 'WXDrive'
fs.watch(wedrive, { recursive: true }, (event, filename) => {
  const filepath = path.join(wedrive, filename)
  // 'rename': 文件被删除，或者新增一个文件，都会收到一个rename事件，
  // 如果filepath对应文件存在，则事新建文件，否则是删除事件
  // 而文件被重命名或者移动时，我们会收到两个rename事件
  if (event === 'rename') {
    
  // 'change: 文件内容被修改时，会收到一个change事件
  } else if (event === 'change') {

  }
})
```

我们可以看到，NodeJS提供的文件监听功能，并不能支持文件重命名和移动事件的监听，这两种情况，我们都会收到两个事件，一个文件旧名字/旧路径对应的删除事件，一个是文件新名字/新路径对应的新建事件。

接下来我们再来看看基于NodeJS开发的比较主流的文件监听组件，最出名的应该就是[chokidar](https://github.com/paulmillr/chokidar),vscode也使用了这个组件。不过调研一番后，发现[chokidar](https://github.com/paulmillr/chokidar)也并不支持文件的重命名和移动事件，不过查看[chokidar](https://github.com/paulmillr/chokidar)的源码之后，也有一些收获，比如，NodeJS提供的`fs.watch`的事件，并不完全准确，以及会有大量噪音事件，这也是需要注意的一个问题。

让我们从实现重命名/移动事件开始，介绍一下微盘如何实现文件监听

一、如何监听文件的重命名与移动事件

我们先来看看，当你删除一个已经存在的文件：`wedrive/work/b.txt`，然后再新建一个文件：`wedrive/work/a.txt`，你会依次收到两个事件

| 事件 | 文件 |
| ---------- | :-----------: |
| `rename` | wedrive/work/b.txt |
| `rename` | wedrive/work/a.txt |

此时，你再把`wedrive/work/a.txt`重命名为`wedrive/work/b.txt`，你会在短时间内收到这样两个事件

| 事件 | 文件 |
| ---------- | :-----------: |
| `rename` | wedrive/work/b.txt |
| `rename` | wedrive/work/a.txt |


微盘作为企业微信办公协作套件之一，2019年年底正式对全部用户开放。产品发布了，接下来写几篇文章记录微盘开发过程中遇到的一些问题与相应的解决方案

我前几年的工作主要在移动端领域，今年第一次尝试桌面端应用开发，同时也尝试了基于Electron的跨平台开发（MacOS 和 PC）。继续编下去，，，


# 总体框架设计

微盘1.0的整体设计可以参考下图

![](/images/wedrive_file_framework.png)

## 一、Render Process
electron承载UI的进程，UI上的操作通过http请求发送给后面 的Node Processs

## 二、Main Process
electron提供的另一个进程，原本应该大部分业务逻辑都放在这个进程，但是由于这个进程处理太重的业务会导致整个Electron应用卡顿，所以fork一个新的进程（下面的Node Process）来承载业务逻辑。

## 三、Node Process
这个进程承载了大部分业务逻辑，包括网络请求、数据库、文件监听等等。

## 四、Plugin
一个原生插件，为了让explore/finder可以在文件和文件夹上展示图标，通过gRPC的方式和Node Process通信



# 我们需要解决什么问题呢？

这里我们通过问题的方式，让大家初步了解微盘文件同步系统具备哪些模块，以及开发过程中遇到了哪些困难。后续文章会一一解答。

## 一、文件监听

为了自动同步本地的文件，我们需要监听本地文件的变化，识别出新建文件、删除文件、重命名文件、移动文件、修改文件内容、复制文件等操作。我们是基于node开发，那么node平台支持怎样的文件监听呢？而我们只需要稍微查询一下[NodeJS的的文件监听接口](https://nodejs.org/docs/latest/api/fs.html#fs_fs_watch_filename_options_listener)，就会发现，这个接口很简单，就是不好用，只支持监听新增、删除、修改三种事件（有时发出的事件可能不准确，但是可以通过一些简单的策略，识别出新增、删除、修改），不支持重命名以及移动事件，这两个操作发生时我们都会收到一个删除事件以及一个新增事件，那我们怎么办呢？下载到本地的文件，用户做了重命名，我们不可能把旧文件标记为未下载，新文件当做新增文件触发上传。

除了重命名和移动的问题，还有另一个棘手的问题，微盘如果退出了，我们这个时候也无法监听本地文件变化了，如果用户在微盘退出期间，对本地的文件操作，下次微盘启动时，我们要如何把离线期间的变化同步给服务器呢？

## 二、数据拉取

如果说拉取文件列表数据，有什么难的呢？聪明的你一定想到我们可以分页将数据按需拉取回来，这里分页的方式可以有两种，

1、不关心层级关系，我们1000条1000条数据将后台的文件索引拉取到本地。
2、可以是每一层的目录作为一页，按需拉取部分目录。

乍一看，第二种方式是比较好的，但是我们会面临一个问题，如下图。

![](/images/wedrive_folderstate.png)

微盘的客户端以及盘符，每个文件夹和文件都有一个状态图标，文件夹的状态图标表示它是不是已经将内部所有文件同步到本地了。那么我们就要一个模块来负责计算文件和文件夹状态，而且同个文件夹，在不同设备上是不同的，取决于这个设备的同步情况，所以，后台不可能负责计算这个状态值，必须由客户端计算。

如果我们按照上面第二种方式拉取数据，进入到哪一级目录就拉取哪一级层级数据，那么当前层级的所有文件夹的状态将都是错的，因为在本地数据库中，这些文件夹内部都是没有文件的，所以，这些文件夹都会显示绿色图标。这明显是不可以接受的。

既然第二种方式拉取数据存在缺陷，那么我们就用第一种方式来，1000个1000个的将数据全部拉取到本地，存入数据库，这样就可以精确计算每个文件和文件夹的状态了。但是有些企业的文件动辄几十万条，全部拉取到本地太不合理了。

## 三、目录结构复杂的变形

微盘客户端从文件列表的服务器接口拉取到一条增量更新数据，我们拿它和数据库对比，发现是某个文件被重命名，那么我们就刷新客户端文件列表，显示新的名字，如果文件已经下载到本地，我们就对它做重命名即可，我们再来看一个复杂一点的情况，我退出了微盘，然后其他同事对某个共享空间的文件做了整理，重命名了部分文件，还做了移动，修改内容，新增，删除等事件，大概可以看这幅图。

![](/images/wedrive10.png)

我们可以看到，左边的树变到右边的树，基本已经面目全非，但是也不影响我们拉取数据，更新数据库，更新客户端文件列表，但是本地的文件，要怎么处理呢？如何让本地的文件从原来的位置，去到新的位置，这个问题的难点在于，每个同步操作都是针对一个路径（新增/删除/内容更新）或者两个路径（重命名/移动）展开的，而这些路径，很大概率会在其他文件的同步过程中被破坏了。


## 四、Windows文件锁定的问题

举个例子，你在微盘下载了一个`高清无码.docx`，然后其他同事对这个文件重命名为`鸡你太美.docx`，你通过长连接push收到这个更新事件，更新数据库，刷新客户端文件列表，然后准备对本地文件做重命名，这个时候你会发现，本地文件依然还是旧名字：`高清无码.docx`，原来重命名失败了，这个问题我们日常也会遇到，如果打开了一个word文档，然后在explore中尝试对它重命名，你就会看到这个弹框

![](/images/wedrive_win_file_lock.png)


# 小结

总结一下以上几个问题
+ 如何实现监听
+ 如何处理同步大量数据与文件状态计算的问题
+ 如何处理复杂的目录结构变形
+ 如何处理Windows文件锁定的问

让我们带着问题来看接下来的文章